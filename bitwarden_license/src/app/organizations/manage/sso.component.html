<div class="page-header d-flex">
  <h1>{{ "singleSignOn" | i18n }}</h1>
</div>

<ng-container *ngIf="loading">
  <i
    class="bwi bwi-spinner bwi-spin text-muted"
    title="{{ 'loading' | i18n }}"
    aria-hidden="true"
  ></i>
  <span class="sr-only">{{ "loading" | i18n }}</span>
</ng-container>

<form
  #form
  (ngSubmit)="submit()"
  [formGroup]="ssoConfigForm"
  [appApiAction]="formPromise"
  *ngIf="!loading"
>
  <p>
    {{ "ssoPolicyHelpStart" | i18n }}
    <a routerLink="../policies">{{ "ssoPolicyHelpLink" | i18n }}</a>
    {{ "ssoPolicyHelpEnd" | i18n }}
    <br />
    {{ "ssoPolicyHelpKeyConnector" | i18n }}
  </p>

  <!-- Root form -->
  <ng-container>
    <div class="form-group">
      <div class="form-check">
        <input
          class="form-check-input"
          type="checkbox"
          id="enabled"
          aria-describedby="allowSsoDesc"
          [formControl]="enabled"
          name="Enabled"
        />
        <label class="form-check-label" for="enabled">{{ "allowSso" | i18n }}</label>
      </div>
      <small id="allowSsoDesc" class="form-text text-muted">{{ "allowSsoDesc" | i18n }}</small>
    </div>

    <div class="form-group">
      <label>{{ "memberDecryptionOption" | i18n }}</label>
      <div class="form-check form-check-block">
        <input
          class="form-check-input"
          type="radio"
          id="memberDecryptionPass"
          [value]="false"
          formControlName="keyConnectorEnabled"
        />
        <label class="form-check-label" for="memberDecryptionPass">
          {{ "masterPass" | i18n }}
          <small>{{ "memberDecryptionPassDesc" | i18n }}</small>
        </label>
      </div>
      <div class="form-check mt-2 form-check-block">
        <input
          class="form-check-input"
          type="radio"
          id="memberDecryptionKey"
          [value]="true"
          formControlName="keyConnectorEnabled"
          [attr.disabled]="!organization.useKeyConnector || null"
        />
        <label class="form-check-label" for="memberDecryptionKey">
          {{ "keyConnector" | i18n }}
          <a
            target="_blank"
            rel="noopener"
            appA11yTitle="{{ 'learnMore' | i18n }}"
            href="https://bitwarden.com/help/about-key-connector/"
          >
            <i class="bwi bwi-question-circle" aria-hidden="true"></i>
          </a>
          <small>{{ "memberDecryptionKeyConnectorDesc" | i18n }}</small>
        </label>
      </div>
    </div>

    <!-- Key Connector -->
    <ng-container *ngIf="ssoConfigForm.get('keyConnectorEnabled').value">
      <app-callout type="warning" [useAlertRole]="true">
        {{ "keyConnectorWarning" | i18n }}
      </app-callout>

      <div class="form-group">
        <label for="keyConnectorUrl">
          {{ "keyConnectorUrl" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <div class="input-group">
          <input
            class="form-control"
            formControlName="keyConnectorUrl"
            id="keyConnectorUrl"
            aria-describedby="keyConnectorUrlDesc"
            (change)="haveTestedKeyConnector = false"
            appChangeStripSpaces
            appA11yInvalid
          />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="validateKeyConnectorUrl()"
              [disabled]="!enableTestKeyConnector"
            >
              <i
                class="bwi bwi-spinner bwi-spin"
                title="{{ 'loading' | i18n }}"
                aria-hidden="true"
                *ngIf="keyConnectorUrl.pending"
              ></i>
              <span *ngIf="!keyConnectorUrl.pending">
                {{ "keyConnectorTest" | i18n }}
              </span>
            </button>
          </div>
        </div>
        <div *ngIf="haveTestedKeyConnector" id="keyConnectorUrlDesc" aria-live="polite">
          <small
            class="error-inline"
            *ngIf="keyConnectorUrl.hasError('invalidUrl'); else keyConnectorSuccess"
          >
            <i class="bwi bwi-exclamation-circle" aria-hidden="true"></i>
            <span class="sr-only">{{ "error" | i18n }}:</span>
            {{ "keyConnectorTestFail" | i18n }}
          </small>
          <ng-template #keyConnectorSuccess>
            <small class="text-success">
              <i class="bwi bwi-check-circle" aria-hidden="true"></i>
              {{ "keyConnectorTestSuccess" | i18n }}
            </small>
          </ng-template>
        </div>
      </div>
    </ng-container>

    <div class="form-group">
      <label for="type"
        >{{ "type" | i18n }}
        <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
      </label>
      <select class="form-control" id="type" formControlName="configType">
        <option *ngFor="let o of ssoTypeOptions" [ngValue]="o.value" disabled="{{ o.disabled }}">
          {{ o.name }}
        </option>
      </select>
    </div>
  </ng-container>

  <!-- OIDC -->
  <div
    *ngIf="ssoConfigForm.get('configType').value === ssoType.OpenIdConnect"
    [formGroup]="openIdForm"
  >
    <div class="config-section">
      <h2 class="secondary-header">{{ "openIdConnectConfig" | i18n }}</h2>
      <app-input-text-readonly
        [label]="'callbackPath' | i18n"
        [controlValue]="callbackPath"
      ></app-input-text-readonly>
      <app-input-text-readonly
        [label]="'signedOutCallbackPath' | i18n"
        [controlValue]="signedOutCallbackPath"
      ></app-input-text-readonly>

      <app-input-text
        [label]="'authority' | i18n"
        controlId="authority"
        [controlRequired]="true"
        [stripSpaces]="true"
        formControlName="authority"
      ></app-input-text>

      <app-input-text
        [label]="'clientId' | i18n"
        controlId="clientId"
        [controlRequired]="true"
        [stripSpaces]="true"
        formControlName="clientId"
      ></app-input-text>

      <app-input-text
        [label]="'clientSecret' | i18n"
        controlId="clientSecret"
        [controlRequired]="true"
        [stripSpaces]="true"
        formControlName="clientSecret"
      ></app-input-text>

      <app-input-text
        [label]="'metadataAddress' | i18n"
        controlId="metadataAddress"
        [stripSpaces]="true"
        [helperText]="'openIdAuthorityRequired' | i18n"
        formControlName="metadataAddress"
      ></app-input-text>

      <div class="form-group">
        <label for="redirectBehavior">
          {{ "oidcRedirectBehavior" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <select class="form-control" formControlName="redirectBehavior" id="redirectBehavior">
          <option *ngFor="let o of connectRedirectOptions" [ngValue]="o.value">{{ o.name }}</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="getClaimsFromUserInfoEndpoint"
            formControlName="getClaimsFromUserInfoEndpoint"
          />
          <label class="form-check-label" for="getClaimsFromUserInfoEndpoint">
            {{ "getClaimsFromUserInfoEndpoint" | i18n }}
          </label>
        </div>
      </div>

      <!-- Optional customizations -->
      <div
        class="section-header d-flex flex-row align-items-center mt-3 mb-3"
        (click)="toggleOpenIdCustomizations()"
      >
        <h3 class="mb-0 mr-2" id="customizations-header">
          {{ "openIdOptionalCustomizations" | i18n }}
        </h3>
        <button
          class="mb-1 btn btn-link"
          type="button"
          appStopClick
          role="button"
          aria-controls="customizations"
          [attr.aria-expanded]="showOpenIdCustomizations"
          aria-labelledby="customizations-header"
        >
          <i
            class="bwi"
            aria-hidden="true"
            [ngClass]="{
              'bwi-angle-down': !showOpenIdCustomizations,
              'bwi-chevron-up': showOpenIdCustomizations
            }"
          ></i>
        </button>
      </div>
      <div id="customizations" [hidden]="!showOpenIdCustomizations">
        <app-input-text
          [label]="'additionalScopes' | i18n"
          controlId="additionalScopes"
          [helperText]="'separateMultipleWithComma' | i18n"
          formControlName="additionalScopes"
        ></app-input-text>

        <app-input-text
          [label]="'additionalUserIdClaimTypes' | i18n"
          controlId="additionalUserIdClaimTypes"
          [helperText]="'separateMultipleWithComma' | i18n"
          formControlName="additionalUserIdClaimTypes"
        ></app-input-text>

        <app-input-text
          [label]="'additionalEmailClaimTypes' | i18n"
          controlId="additionalEmailClaimTypes"
          [helperText]="'separateMultipleWithComma' | i18n"
          formControlName="additionalEmailClaimTypes"
        ></app-input-text>

        <app-input-text
          [label]="'additionalNameClaimTypes' | i18n"
          controlId="additionalNameClaimTypes"
          [helperText]="'separateMultipleWithComma' | i18n"
          formControlName="additionalNameClaimTypes"
        ></app-input-text>

        <app-input-text
          [label]="'acrValues' | i18n"
          controlId="acrValues"
          helperText="acr_values"
          formControlName="acrValues"
        ></app-input-text>

        <app-input-text
          [label]="'expectedReturnAcrValue' | i18n"
          controlId="expectedReturnAcrValue"
          helperText="acr_validation"
          formControlName="expectedReturnAcrValue"
        ></app-input-text>
      </div>
    </div>
  </div>

  <!-- SAML2 SP -->
  <div *ngIf="ssoConfigForm.get('configType').value === ssoType.Saml2" [formGroup]="samlForm">
    <!-- SAML2 SP -->
    <div class="config-section">
      <h2 class="secondary-header">{{ "samlSpConfig" | i18n }}</h2>
      <app-input-text-readonly
        [label]="'spEntityId' | i18n"
        [controlValue]="spEntityId"
      ></app-input-text-readonly>
      <app-input-text-readonly
        [label]="'spMetadataUrl' | i18n"
        [controlValue]="spMetadataUrl"
        [showLaunch]="true"
      ></app-input-text-readonly>
      <app-input-text-readonly
        [label]="'spAcsUrl' | i18n"
        [controlValue]="spAcsUrl"
      ></app-input-text-readonly>
      <div class="form-group">
        <label for="spNameIdFormat">{{ "spNameIdFormat" | i18n }}</label>
        <select class="form-control" formControlName="spNameIdFormat" id="spNameIdFormat">
          <option *ngFor="let o of saml2NameIdFormatOptions" [ngValue]="o.value">
            {{ o.name }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="spOutboundSigningAlgorithm">{{ "spOutboundSigningAlgorithm" | i18n }}</label>
        <select
          class="form-control"
          formControlName="spOutboundSigningAlgorithm"
          id="spOutboundSigningAlgorithm"
        >
          <option *ngFor="let o of samlSigningAlgorithms" [ngValue]="o">{{ o }}</option>
        </select>
      </div>
      <div class="form-group">
        <label for="spSigningBehavior">{{ "spSigningBehavior" | i18n }}</label>
        <select class="form-control" formControlName="spSigningBehavior" id="spSigningBehavior">
          <option *ngFor="let o of saml2SigningBehaviourOptions" [ngValue]="o.value">
            {{ o.name }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="spMinIncomingSigningAlgorithm">{{
          "spMinIncomingSigningAlgorithm" | i18n
        }}</label>
        <select
          class="form-control"
          formControlName="spMinIncomingSigningAlgorithm"
          id="spMinIncomingSigningAlgorithm"
        >
          <option *ngFor="let o of samlSigningAlgorithms" [ngValue]="o">{{ o }}</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="spWantAssertionsSigned"
            formControlName="spWantAssertionsSigned"
          />
          <label class="form-check-label" for="spWantAssertionsSigned">
            {{ "spWantAssertionsSigned" | i18n }}
          </label>
        </div>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="spValidateCertificates"
            formControlName="spValidateCertificates"
          />
          <label class="form-check-label" for="spValidateCertificates">
            {{ "spValidateCertificates" | i18n }}
          </label>
        </div>
      </div>
    </div>

    <!-- SAML2 IDP -->
    <div class="config-section">
      <h2 class="secondary-header">{{ "samlIdpConfig" | i18n }}</h2>

      <app-input-text
        [label]="'idpEntityId' | i18n"
        controlId="idpEntityId"
        [controlRequired]="true"
        formControlName="idpEntityId"
      ></app-input-text>

      <div class="form-group">
        <label for="idpBindingType">{{ "idpBindingType" | i18n }}</label>
        <select class="form-control" formControlName="idpBindingType" id="idpBindingType">
          <option *ngFor="let o of saml2BindingTypeOptions" [ngValue]="o.value">
            {{ o.name }}
          </option>
        </select>
      </div>

      <app-input-text
        [label]="'idpSingleSignOnServiceUrl' | i18n"
        controlId="idpSingleSignOnServiceUrl"
        [helperText]="'idpSingleSignOnServiceUrlRequired' | i18n"
        [stripSpaces]="true"
        formControlName="idpSingleSignOnServiceUrl"
      ></app-input-text>

      <app-input-text
        [label]="'idpSingleLogoutServiceUrl' | i18n"
        controlId="idpSingleLogoutServiceUrl"
        [stripSpaces]="true"
        formControlName="idpSingleLogoutServiceUrl"
      ></app-input-text>

      <div class="form-group">
        <label for="idpArtifactResolutionServiceUrl">{{
          "idpArtifactResolutionServiceUrl" | i18n
        }}</label>
        <input
          class="form-control"
          formControlName="idpArtifactResolutionServiceUrl"
          id="idpArtifactResolutionServiceUrl"
          appChangeStripSpaces
          appA11yInvalid
          aria-describedby="idpArtifactResolutionServiceUrlDesc"
        />
        <div id="idpArtifactResolutionServiceUrlDesc">
          <small
            class="error-inline"
            *ngIf="
              samlForm.get('idpArtifactResolutionServiceUrl').hasError('required');
              else idpArtifactHelperText
            "
            role="alert"
          >
            <i class="bwi bwi-exclamation-circle" aria-hidden="true"></i>
            <span class="sr-only">{{ "error" | i18n }}:</span>
            {{ "idpArtifactResolutionRequired" | i18n }}
          </small>
          <ng-template #idpArtifactHelperText>
            <small class="form-text text-muted">
              {{ "idpArtifactResolutionRequired" | i18n }}
            </small>
          </ng-template>
        </div>
      </div>
      <div class="form-group">
        <label for="idpX509PublicCert">
          {{ "idpX509PublicCert" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <textarea
          formControlName="idpX509PublicCert"
          class="form-control form-control-sm text-monospace"
          rows="6"
          id="idpX509PublicCert"
          appA11yInvalid
          aria-describedby="idpX509PublicCertDesc"
        ></textarea>
        <small
          id="idpX509PublicCertDesc"
          class="error-inline"
          role="alert"
          *ngIf="samlForm.get('idpX509PublicCert').hasError('required')"
        >
          <i class="bwi bwi-exclamation-circle" aria-hidden="true"></i>
          <span class="sr-only">{{ "error" | i18n }}:</span>
          {{ "fieldRequiredError" | i18n: ("idpX509PublicCert" | i18n) }}
        </small>
      </div>
      <div class="form-group">
        <label for="idpOutboundSigningAlgorithm">{{ "idpOutboundSigningAlgorithm" | i18n }}</label>
        <select
          class="form-control"
          formControlName="idpOutboundSigningAlgorithm"
          id="idpOutboundSigningAlgorithm"
        >
          <option *ngFor="let o of samlSigningAlgorithms" [ngValue]="o">{{ o }}</option>
        </select>
      </div>
      <div class="form-group" [hidden]="true">
        <!--TODO: Unhide once Unsolicited IdP Response is supported-->
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="idpAllowUnsolicitedAuthnResponse"
            formControlName="idpAllowUnsolicitedAuthnResponse"
          />
          <label class="form-check-label" for="idpAllowUnsolicitedAuthnResponse">
            {{ "idpAllowUnsolicitedAuthnResponse" | i18n }}
          </label>
        </div>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="idpAllowOutboundLogoutRequests"
            formControlName="idpAllowOutboundLogoutRequests"
          />
          <label class="form-check-label" for="idpAllowOutboundLogoutRequests">
            {{ "idpAllowOutboundLogoutRequests" | i18n }}
          </label>
        </div>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="idpWantAuthnRequestsSigned"
            formControlName="idpWantAuthnRequestsSigned"
          />
          <label class="form-check-label" for="idpWantAuthnRequestsSigned">
            {{ "idpSignAuthenticationRequests" | i18n }}
          </label>
        </div>
      </div>
    </div>
  </div>

  <button type="submit" class="btn btn-primary btn-submit" [disabled]="form.loading">
    <i class="bwi bwi-spinner bwi-spin" title="{{ 'loading' | i18n }}" aria-hidden="true"></i>
    <span>{{ "save" | i18n }}</span>
  </button>
  <div
    id="errorSummary"
    class="error-summary text-danger"
    *ngIf="this.getErrorCount(ssoConfigForm) as errorCount"
  >
    <i class="bwi bwi-exclamation-circle" aria-hidden="true"></i>
    <span class="sr-only">{{ "error" | i18n }}:</span>
    {{
      (errorCount === 1 ? "formErrorSummarySingle" : "formErrorSummaryPlural") | i18n: errorCount
    }}
  </div>
</form>
