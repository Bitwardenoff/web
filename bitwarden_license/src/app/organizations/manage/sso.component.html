<div class="page-header d-flex">
  <h1>{{ "singleSignOn" | i18n }}</h1>
</div>

<ng-container *ngIf="loading">
  <i class="fa fa-spinner fa-spin text-muted" title="{{ 'loading' | i18n }}" aria-hidden="true"></i>
  <span class="sr-only">{{ "loading" | i18n }}</span>
</ng-container>

<form
  #form
  (ngSubmit)="submit()"
  [formGroup]="ssoConfigForm"
  [appApiAction]="formPromise"
  *ngIf="!loading"
>
  <p>
    {{ "ssoPolicyHelpStart" | i18n }}
    <a routerLink="../policies">{{ "ssoPolicyHelpLink" | i18n }}</a>
    {{ "ssoPolicyHelpEnd" | i18n }}
    <br />
    {{ "ssoPolicyHelpKeyConnector" | i18n }}
  </p>

  <!-- Root form -->
  <ng-container>
    <div class="form-group">
      <div class="form-check">
        <input
          class="form-check-input"
          type="checkbox"
          id="enabled"
          aria-describedby="allowSsoDesc"
          [formControl]="enabled"
          name="Enabled"
        />
        <label class="form-check-label" for="enabled">{{ "allowSso" | i18n }}</label>
      </div>
      <small id="allowSsoDesc" class="form-text text-muted">{{ "allowSsoDesc" | i18n }}</small>
    </div>

    <div class="form-group">
      <label>{{ "memberDecryptionOption" | i18n }}</label>
      <div class="form-check form-check-block">
        <input
          class="form-check-input"
          type="radio"
          id="memberDecryptionPass"
          [value]="false"
          formControlName="keyConnectorEnabled"
        />
        <label class="form-check-label" for="memberDecryptionPass">
          {{ "masterPass" | i18n }}
          <small>{{ "memberDecryptionPassDesc" | i18n }}</small>
        </label>
      </div>
      <div class="form-check mt-2 form-check-block">
        <input
          class="form-check-input"
          type="radio"
          id="memberDecryptionKey"
          [value]="true"
          formControlName="keyConnectorEnabled"
          [attr.disabled]="!organization.useKeyConnector || null"
        />
        <label class="form-check-label" for="memberDecryptionKey">
          {{ "keyConnector" | i18n }}
          <a
            target="_blank"
            rel="noopener"
            appA11yTitle="{{ 'learnMore' | i18n }}"
            href="https://bitwarden.com/help/article/about-key-connector/"
          >
            <i class="fa fa-question-circle-o" aria-hidden="true"></i>
          </a>
          <small>{{ "memberDecryptionKeyConnectorDesc" | i18n }}</small>
        </label>
      </div>
    </div>

    <!-- Key Connector -->
    <ng-container *ngIf="ssoConfigForm.get('keyConnectorEnabled').value">
      <app-callout type="warning" [useAlertRole]="true">
        {{ "keyConnectorWarning" | i18n }}
      </app-callout>

      <div class="form-group">
        <label for="keyConnectorUrl">
          {{ "keyConnectorUrl" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <div class="input-group">
          <input
            class="form-control"
            formControlName="keyConnectorUrl"
            id="keyConnectorUrl"
            aria-describedby="keyConnectorUrlDesc"
            (change)="haveTestedKeyConnector = false"
            appChangeStripSpaces
            appA11yInvalid
          />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="validateKeyConnectorUrl()"
              [disabled]="!enableTestKeyConnector"
            >
              <i
                class="fa fa-spinner fa-spin"
                title="{{ 'loading' | i18n }}"
                aria-hidden="true"
                *ngIf="keyConnectorUrl.pending"
              ></i>
              <span *ngIf="!keyConnectorUrl.pending">
                {{ "keyConnectorTest" | i18n }}
              </span>
            </button>
          </div>
        </div>
        <div *ngIf="haveTestedKeyConnector" id="keyConnectorUrlDesc" aria-live="polite">
          <small
            class="error-inline"
            *ngIf="keyConnectorUrl.hasError('invalidUrl'); else keyConnectorSuccess"
          >
            <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
            <span class="sr-only">{{ "error" | i18n }}:</span>
            {{ "keyConnectorTestFail" | i18n }}
          </small>
          <ng-template #keyConnectorSuccess>
            <small class="text-success">
              <i class="fa fa-check-circle-o" aria-hidden="true"></i>
              {{ "keyConnectorTestSuccess" | i18n }}
            </small>
          </ng-template>
        </div>
      </div>
    </ng-container>

    <div class="form-group">
      <label for="type"
        >{{ "type" | i18n }}
        <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
      </label>
      <select class="form-control" id="type" formControlName="configType">
        <option *ngFor="let o of ssoTypeOptions" [ngValue]="o.value" disabled="{{ o.disabled }}">
          {{ o.name }}
        </option>
      </select>
    </div>
  </ng-container>

  <!-- OIDC -->
  <div
    *ngIf="ssoConfigForm.get('configType').value === ssoType.OpenIdConnect"
    [formGroup]="openIdForm"
  >
    <div class="config-section">
      <h2 class="secondary-header">{{ "openIdConnectConfig" | i18n }}</h2>
      <div class="form-group">
        <label>{{ "callbackPath" | i18n }}</label>
        <div class="input-group">
          <input class="form-control" readonly [value]="callbackPath" />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-secondary"
              appA11yTitle="{{ 'copyValue' | i18n }}"
              (click)="copy(callbackPath)"
            >
              <i class="fa fa-lg fa-clone" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>{{ "signedOutCallbackPath" | i18n }}</label>
        <div class="input-group">
          <input class="form-control" readonly [value]="signedOutCallbackPath" />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-secondary"
              appA11yTitle="{{ 'copyValue' | i18n }}"
              (click)="copy(signedOutCallbackPath)"
            >
              <i class="fa fa-lg fa-clone" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="authority">
          {{ "authority" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <input
          class="form-control"
          formControlName="authority"
          id="authority"
          aria-describedby="authorityDesc"
          appChangeStripSpaces
          appA11yInvalid
        />
        <small
          id="authorityDesc"
          class="error-inline"
          *ngIf="openIdForm.get('authority').hasError('required')"
          role="alert"
        >
          <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
          <span class="sr-only">{{ "error" | i18n }}:</span>
          {{ "fieldRequiredError" | i18n: ("authority" | i18n) }}
        </small>
      </div>
      <div class="form-group">
        <label for="clientId">
          {{ "clientId" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <input
          class="form-control"
          formControlName="clientId"
          id="clientId"
          aria-describedby="clientIdDesc"
          appA11yInvalid
        />
        <small
          id="clientIdDesc"
          class="error-inline"
          *ngIf="openIdForm.get('clientId').hasError('required')"
          role="alert"
        >
          <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
          <span class="sr-only">{{ "error" | i18n }}:</span>
          {{ "fieldRequiredError" | i18n: ("clientId" | i18n) }}
        </small>
      </div>
      <div class="form-group">
        <label for="clientSecret">
          {{ "clientSecret" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <input
          class="form-control"
          formControlName="clientSecret"
          id="clientSecret"
          aria-describedby="clientSecretDesc"
          appA11yInvalid
        />
        <small
          id="clientSecretDesc"
          class="error-inline"
          *ngIf="openIdForm.get('clientSecret').hasError('required')"
          role="alert"
        >
          <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
          <span class="sr-only">{{ "error" | i18n }}:</span>
          {{ "fieldRequiredError" | i18n: ("clientSecret" | i18n) }}
        </small>
      </div>
      <div class="form-group">
        <label for="metadataAddress">{{ "metadataAddress" | i18n }}</label>
        <input
          class="form-control"
          formControlName="metadataAddress"
          id="metadataAddress"
          aria-describedby="metadataAddressDesc"
          appChangeStripSpaces
        />
        <small id="metadataAddressDesc" class="text-muted form-text">
          {{ "openIdAuthorityRequired" | i18n }}
        </small>
      </div>
      <div class="form-group">
        <label for="redirectBehavior">
          {{ "oidcRedirectBehavior" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <select class="form-control" formControlName="redirectBehavior" id="redirectBehavior">
          <option *ngFor="let o of connectRedirectOptions" [ngValue]="o.value">{{ o.name }}</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="getClaimsFromUserInfoEndpoint"
            formControlName="getClaimsFromUserInfoEndpoint"
          />
          <label class="form-check-label" for="getClaimsFromUserInfoEndpoint">
            {{ "getClaimsFromUserInfoEndpoint" | i18n }}
          </label>
        </div>
      </div>

      <!-- Optional customizations -->
      <div
        class="section-header d-flex flex-row align-items-center mt-3 mb-3"
        (click)="toggleOpenIdCustomizations()"
      >
        <h3 class="mb-0 mr-2" id="customizations-header">
          {{ "openIdOptionalCustomizations" | i18n }}
        </h3>
        <button
          class="mb-1 btn btn-link"
          type="button"
          appStopClick
          role="button"
          aria-controls="customizations"
          [attr.aria-expanded]="showOpenIdCustomizations"
          aria-labelledby="customizations-header"
        >
          <i
            class="fa"
            aria-hidden="true"
            [ngClass]="{
              'fa-chevron-down': !showOpenIdCustomizations,
              'fa-chevron-up': showOpenIdCustomizations
            }"
          ></i>
        </button>
      </div>
      <div id="customizations" [hidden]="!showOpenIdCustomizations">
        <div class="form-group">
          <label for="additionalScopes">{{ "additionalScopes" | i18n }}</label>
          <input
            class="form-control"
            formControlName="additionalScopes"
            id="additionalScopes"
            aria-describedby="additionalScopesDesc"
          />
          <small class="form-text text-muted" id="additionalScopesDesc">
            {{ "separateMultipleWithComma" | i18n }}
          </small>
        </div>
        <div class="form-group">
          <label for="additionalUserIdClaimTypes">{{ "additionalUserIdClaimTypes" | i18n }}</label>
          <input
            class="form-control"
            formControlName="additionalUserIdClaimTypes"
            id="additionalUserIdClaimTypes"
            aria-describedby="additionalUserIdClaimTypesDesc"
          />
          <small id="additionalUserIdClaimTypesDesc" class="form-text text-muted">
            {{ "separateMultipleWithComma" | i18n }}
          </small>
        </div>
        <div class="form-group">
          <label for="additionalEmailClaimTypes">{{ "additionalEmailClaimTypes" | i18n }}</label>
          <input
            class="form-control"
            formControlName="additionalEmailClaimTypes"
            id="additionalEmailClaimTypes"
            aria-describedby="additionalEmailClaimTypesDesc"
          />
          <small id="additionalEmailClaimTypesDesc" class="form-text text-muted">
            {{ "separateMultipleWithComma" | i18n }}
          </small>
        </div>
        <div class="form-group">
          <label for="additionalNameClaimTypes">{{ "additionalNameClaimTypes" | i18n }}</label>
          <input
            class="form-control"
            formControlName="additionalNameClaimTypes"
            id="additionalNameClaimTypes"
            aria-describedby="additionalNameClaimTypesDesc"
          />
          <small id="additionalNameClaimTypesDesc" class="form-text text-muted">
            {{ "separateMultipleWithComma" | i18n }}
          </small>
        </div>
        <div class="form-group">
          <label for="acrValues">{{ "acrValues" | i18n }}</label>
          <input
            class="form-control"
            formControlName="acrValues"
            id="acrValues"
            aria-describedby="acrValuesDesc"
          />
          <small id="acrValuesDesc" class="form-text text-muted"> acr_values </small>
        </div>
        <div class="form-group">
          <label for="expectedReturnAcrValue">{{ "expectedReturnAcrValue" | i18n }}</label>
          <input
            class="form-control"
            formControlName="expectedReturnAcrValue"
            id="expectedReturnAcrValue"
            aria-describedby="expectedReturnAcrValueDesc"
          />
          <small id="expectedReturnAcrValueDesc" class="form-text text-muted">
            acr_validation
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- SAML2 SP -->
  <div *ngIf="ssoConfigForm.get('configType').value === ssoType.Saml2" [formGroup]="samlForm">
    <!-- SAML2 SP -->
    <div class="config-section">
      <h2 class="secondary-header">{{ "samlSpConfig" | i18n }}</h2>
      <div class="form-group">
        <label>{{ "spEntityId" | i18n }}</label>
        <div class="input-group">
          <input class="form-control" readonly [value]="spEntityId" />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-secondary"
              appA11yTitle="{{ 'copyValue' | i18n }}"
              (click)="copy(spEntityId)"
            >
              <i class="fa fa-lg fa-clone" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>{{ "spMetadataUrl" | i18n }}</label>
        <div class="input-group">
          <input class="form-control" readonly [value]="spMetadataUrl" />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-secondary"
              appA11yTitle="{{ 'launch' | i18n }}"
              (click)="launchUri(spMetadataUrl)"
            >
              <i class="fa fa-lg fa-external-link" aria-hidden="true"></i>
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              appA11yTitle="{{ 'copyValue' | i18n }}"
              (click)="copy(spMetadataUrl)"
            >
              <i class="fa fa-lg fa-clone" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>{{ "spAcsUrl" | i18n }}</label>
        <div class="input-group">
          <input class="form-control" readonly [value]="spAcsUrl" />
          <div class="input-group-append">
            <button
              type="button"
              class="btn btn-outline-secondary"
              appA11yTitle="{{ 'copyValue' | i18n }}"
              (click)="copy(spAcsUrl)"
            >
              <i class="fa fa-lg fa-clone" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="spNameIdFormat">{{ "spNameIdFormat" | i18n }}</label>
        <select class="form-control" formControlName="spNameIdFormat" id="spNameIdFormat">
          <option *ngFor="let o of saml2NameIdFormatOptions" [ngValue]="o.value">
            {{ o.name }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="spOutboundSigningAlgorithm">{{ "spOutboundSigningAlgorithm" | i18n }}</label>
        <select
          class="form-control"
          formControlName="spOutboundSigningAlgorithm"
          id="spOutboundSigningAlgorithm"
        >
          <option *ngFor="let o of samlSigningAlgorithms" [ngValue]="o">{{ o }}</option>
        </select>
      </div>
      <div class="form-group">
        <label for="spSigningBehavior">{{ "spSigningBehavior" | i18n }}</label>
        <select class="form-control" formControlName="spSigningBehavior" id="spSigningBehavior">
          <option *ngFor="let o of saml2SigningBehaviourOptions" [ngValue]="o.value">
            {{ o.name }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="spMinIncomingSigningAlgorithm">{{
          "spMinIncomingSigningAlgorithm" | i18n
        }}</label>
        <select
          class="form-control"
          formControlName="spMinIncomingSigningAlgorithm"
          id="spMinIncomingSigningAlgorithm"
        >
          <option *ngFor="let o of samlSigningAlgorithms" [ngValue]="o">{{ o }}</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="spWantAssertionsSigned"
            formControlName="spWantAssertionsSigned"
          />
          <label class="form-check-label" for="spWantAssertionsSigned">
            {{ "spWantAssertionsSigned" | i18n }}
          </label>
        </div>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="spValidateCertificates"
            formControlName="spValidateCertificates"
          />
          <label class="form-check-label" for="spValidateCertificates">
            {{ "spValidateCertificates" | i18n }}
          </label>
        </div>
      </div>
    </div>

    <!-- SAML2 IDP -->
    <div class="config-section">
      <h2 class="secondary-header">{{ "samlIdpConfig" | i18n }}</h2>

      <div class="form-group">
        <label for="idpEntityId">
          {{ "idpEntityId" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <input
          class="form-control"
          formControlName="idpEntityId"
          id="idpEntityId"
          appA11yInvalid
          aria-describedby="idpEntityIdDesc"
        />
        <small
          id="idpEntityIdDesc"
          class="error-inline"
          *ngIf="samlForm.get('idpEntityId').hasError('required')"
          role="alert"
        >
          <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
          <span class="sr-only">{{ "error" | i18n }}:</span>
          {{ "fieldRequiredError" | i18n: ("idpEntityId" | i18n) }}
        </small>
      </div>
      <div class="form-group">
        <label for="idpBindingType">{{ "idpBindingType" | i18n }}</label>
        <select class="form-control" formControlName="idpBindingType" id="idpBindingType">
          <option *ngFor="let o of saml2BindingTypeOptions" [ngValue]="o.value">
            {{ o.name }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="idpSingleSignOnServiceUrl">{{ "idpSingleSignOnServiceUrl" | i18n }}</label>
        <input
          class="form-control"
          formControlName="idpSingleSignOnServiceUrl"
          id="idpSingleSignOnServiceUrl"
          aria-describedby="idpSingleSignOnServiceUrlDesc"
          appChangeStripSpaces
        />
        <small id="idpSingleSignOnServiceUrlDesc" class="form-text text-muted">
          {{ "idpSingleSignOnServiceUrlRequired" | i18n }}
        </small>
      </div>
      <div class="form-group">
        <label for="idpSingleLogoutServiceUrl">{{ "idpSingleLogoutServiceUrl" | i18n }}</label>
        <input
          class="form-control"
          formControlName="idpSingleLogoutServiceUrl"
          id="idpSingleLogoutServiceUrl"
          appChangeStripSpaces
        />
      </div>
      <div class="form-group">
        <label for="idpArtifactResolutionServiceUrl">{{
          "idpArtifactResolutionServiceUrl" | i18n
        }}</label>
        <input
          class="form-control"
          formControlName="idpArtifactResolutionServiceUrl"
          id="idpArtifactResolutionServiceUrl"
          appChangeStripSpaces
          appA11yInvalid
          aria-describedby="idpArtifactResolutionServiceUrlDesc"
        />
        <div id="idpArtifactResolutionServiceUrlDesc">
          <small
            class="error-inline"
            *ngIf="
              samlForm.get('idpArtifactResolutionServiceUrl').hasError('required');
              else idpArtifactHelperText
            "
            role="alert"
          >
            <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
            <span class="sr-only">{{ "error" | i18n }}:</span>
            {{ "idpArtifactResolutionRequired" | i18n }}
          </small>
          <ng-template #idpArtifactHelperText>
            <small class="form-text text-muted">
              {{ "idpArtifactResolutionRequired" | i18n }}
            </small>
          </ng-template>
        </div>
      </div>
      <div class="form-group">
        <label for="idpX509PublicCert">
          {{ "idpX509PublicCert" | i18n }}
          <small class="text-muted form-text d-inline">({{ "required" | i18n }})</small>
        </label>
        <textarea
          formControlName="idpX509PublicCert"
          class="form-control form-control-sm text-monospace"
          rows="6"
          id="idpX509PublicCert"
          appA11yInvalid
          aria-describedby="idpX509PublicCertDesc"
        ></textarea>
        <small
          id="idpX509PublicCertDesc"
          class="error-inline"
          role="alert"
          *ngIf="samlForm.get('idpX509PublicCert').hasError('required')"
        >
          <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
          <span class="sr-only">{{ "error" | i18n }}:</span>
          {{ "fieldRequiredError" | i18n: ("idpX509PublicCert" | i18n) }}
        </small>
      </div>
      <div class="form-group">
        <label for="idpOutboundSigningAlgorithm">{{ "idpOutboundSigningAlgorithm" | i18n }}</label>
        <select
          class="form-control"
          formControlName="idpOutboundSigningAlgorithm"
          id="idpOutboundSigningAlgorithm"
        >
          <option *ngFor="let o of samlSigningAlgorithms" [ngValue]="o">{{ o }}</option>
        </select>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="idpAllowUnsolicitedAuthnResponse"
            formControlName="idpAllowUnsolicitedAuthnResponse"
          />
          <label class="form-check-label" for="idpAllowUnsolicitedAuthnResponse">
            {{ "idpAllowUnsolicitedAuthnResponse" | i18n }}
          </label>
        </div>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="idpAllowOutboundLogoutRequests"
            formControlName="idpAllowOutboundLogoutRequests"
          />
          <label class="form-check-label" for="idpAllowOutboundLogoutRequests">
            {{ "idpAllowOutboundLogoutRequests" | i18n }}
          </label>
        </div>
      </div>
      <div class="form-group">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            id="idpWantAuthnRequestsSigned"
            formControlName="idpWantAuthnRequestsSigned"
          />
          <label class="form-check-label" for="idpWantAuthnRequestsSigned">
            {{ "idpSignAuthenticationRequests" | i18n }}
          </label>
        </div>
      </div>
    </div>
  </div>

  <button type="submit" class="btn btn-primary btn-submit" [disabled]="form.loading">
    <i class="fa fa-spinner fa-spin" title="{{ 'loading' | i18n }}" aria-hidden="true"></i>
    <span>{{ "save" | i18n }}</span>
  </button>
  <div
    id="errorSummary"
    class="error-summary text-danger"
    *ngIf="this.getErrorCount(ssoConfigForm) as errorCount"
  >
    <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
    <span class="sr-only">{{ "error" | i18n }}:</span>
    {{
      (errorCount === 1 ? "formErrorSummarySingle" : "formErrorSummaryPlural") | i18n: errorCount
    }}
  </div>
</form>
